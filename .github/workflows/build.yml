name: ðŸ” Smart Diagnostic Build with Error Categorization

on:
  workflow_dispatch:

jobs:
  diagnose-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ==========1 å½»åº•æ¸…ç†çŽ¯å¢ƒï¼Œç¡®ä¿æ— ç¼“å­˜æ®‹ç•™ ==========
      - name: ðŸ§¹ Wipe Gradle caches and warm up Kotlin DSL
        run: |
          ./gradlew --stop
          rm -rf ~/.gradle/caches/
          ./gradlew help --stacktrace

      # ========== è¯Šæ–­é˜¶æ®µ ==========
      - name: ðŸ“‹ Collect environment info
        run: |
          echo "### System Info" >> $GITHUB_STEP_SUMMARY
          echo "- Java: $(java -version 2>&1 | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "- Gradle Wrapper version: $(./gradlew --version | grep "Gradle ")" >> $GITHUB_STEP_SUMMARY
          echo "- Kotlin: $(./gradlew --version | grep "Kotlin:")" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Check Gradle & AGP compatibility
        run: |
          GRADLE_VERSION=$(grep distributionUrl gradle/wrapper/gradle-wrapper.properties | grep -oE 'gradle-[0-9.]+' | cut -d- -f2)
          AGP_VERSION=$(grep -E "com.android.application.*version" build.gradle.kts | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "unknown")
          echo "### Compatibility Check" >> $GITHUB_STEP_SUMMARY
          echo "- Gradle version: $GRADLE_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- AGP version: $AGP_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ If you encounter issues, ensure Gradle and AGP versions are compatible." >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“„ Show app/build.gradle.kts content (head)
        run: head -50 app/build.gradle.kts

      - name: ðŸ”§ Ensure compileSdk in app/build.gradle.kts (optional)
        run: |
          if ! grep -q "compileSdk = 35" app/build.gradle.kts; then
            echo "âš ï¸ compileSdk not found. You may need to add 'compileSdk = 35' manually." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… compileSdk found." >> $GITHUB_STEP_SUMMARY
          fi

      # ========== åˆ·æ–°ä¾èµ–ï¼ˆæ¸…ç†åŽæ— éœ€é‡å¤ï¼‰ ==========
      - name: ðŸ§¹ Clean and refresh dependencies
        run: ./gradlew clean --refresh-dependencies

      # ========== è¯Šæ–­ï¼šç¡®è®¤ JavaPoet ç‰ˆæœ¬ ==========
      - name: ðŸ”Ž Verify JavaPoet version
        run: |
          echo "### JavaPoet version (debug compile classpath)" >> $GITHUB_STEP_SUMMARY
          ./gradlew -q app:dependencies --configuration debugCompileClasspath | grep javapoet | head -5 >> $GITHUB_STEP_SUMMARY || echo "Not found" >> $GITHUB_STEP_SUMMARY

      # ========== é¦–æ¬¡æž„å»ºå°è¯• ==========
      - name: ðŸ—ï¸ First build attempt
        id: first_build
        run: |
          ./gradlew assembleDebug --stacktrace 2>&1 | tee build.log
        continue-on-error: true

      # ========== æ£€æµ‹æ˜¯å¦éœ€è¦è‡ªåŠ¨ä¿®å¤ï¼ˆHilt/JavaPoet å†²çªï¼‰ ==========
      - name: ðŸ”Ž Check if Hilt/JavaPoet conflict fix is needed
        id: check_fix
        run: |
          if grep -q "java.lang.NoSuchMethodError.*javapoet\|com.squareup.javapoet.ClassName.canonicalName" build.log; then
            echo "need_fix=true" >> $GITHUB_OUTPUT
          else
            echo "need_fix=false" >> $GITHUB_OUTPUT
          fi

      # ========== æ™ºèƒ½é”™è¯¯å¤„ç†ï¼šå¼ºåˆ¶æ¸…ç†ç¼“å­˜å¹¶é‡è¯•ï¼ˆæ‚¨å·²æ‰‹åŠ¨æ·»åŠ  resolutionStrategyï¼Œæ— éœ€ä¿®æ”¹æ–‡ä»¶ï¼‰ ==========
      - name: ðŸ› ï¸ Auto-fix for Hilt/JavaPoet conflict
        if: steps.check_fix.outputs.need_fix == 'true'
        run: |
          echo "Detected Hilt/JavaPoet conflict. Forcing cache cleanup and retry..."
          ./gradlew --stop
          rm -rf ~/.gradle/caches/
          ./gradlew clean assembleDebug --stacktrace 2>&1 | tee build_fixed.log
          cp build_fixed.log build.log
        continue-on-error: true

      # ========== è¾“å‡º JavaPoet çš„è¯¦ç»†ä¾èµ–ä¿¡æ¯ï¼ˆè¯Šæ–­ç”¨ï¼‰ ==========
      - name: ðŸ” Debug JavaPoet version (dependency insight)
        if: always()
        run: |
          echo "### JavaPoet version insight" >> $GITHUB_STEP_SUMMARY
          ./gradlew app:dependencyInsight --dependency javapoet --configuration debugCompileClasspath >> $GITHUB_STEP_SUMMARY || true

      # ========== åˆ†ç±»é”™è¯¯æŠ¥å‘Šï¼ˆåŸºäºŽæœ€ç»ˆçš„ build.logï¼‰ ==========
      - name: ðŸ“Š Generate categorized error report
        if: always()
        run: |
          echo "# ðŸ“‹ Build Diagnostic Report (Categorized)" > final-report.md
          echo "" >> final-report.md
          echo "## ðŸ” Summary" >> final-report.md
          if [ -f build.log ]; then
            if grep -q "BUILD SUCCESSFUL" build.log; then
              echo "âœ… **Build succeeded**" >> final-report.md
            else
              echo "âŒ **Build failed**" >> final-report.md
              echo "" >> final-report.md
              echo "### ðŸ“Š Error Categories" >> final-report.md
              
              declare -A error_patterns=(
                ["KSP/Kotlinç‰ˆæœ¬ä¸å…¼å®¹"]="ksp.*is too new for kotlin"
                ["æŒ‚èµ·å‡½æ•°è°ƒç”¨é”™è¯¯"]="Suspend function.*should be called only from a coroutine"
                ["æœªè§£å†³çš„å¼•ç”¨"]="Unresolved reference"
                ["ç±»åž‹ä¸åŒ¹é…"]="type mismatch"
                ["å‚æ•°ä¸åŒ¹é…"]="No value passed for parameter|Cannot find a parameter"
                ["å‡½æ•°é‡è½½å†²çª"]="Conflicting overloads"
                ["ç¼ºå°‘å¯¼å…¥"]="Unresolved reference.*(import|kotlinx)"
                ["Composeä¸Šä¸‹æ–‡é”™è¯¯"]="@Composable invocations can only happen from the context of a @Composable function"
                ["èµ„æºç¼ºå¤±"]="resource.*not found"
                ["ä¾èµ–å†²çª"]="Conflict|dependency convergence"
                ["Hilt/JavaPoetå†²çª"]="java.lang.NoSuchMethodError.*javapoet|com.squareup.javapoet.ClassName.canonicalName"
                ["å…¶ä»–é”™è¯¯"]="^e:|^error:|FAILURE:"
              )
              
              for category in "${!error_patterns[@]}"; do
                pattern="${error_patterns[$category]}"
                count=$(grep -E "$pattern" build.log | wc -l)
                if [ "$count" -gt 0 ]; then
                  echo "- **$category**: $count occurrences" >> final-report.md
                  echo '  ```' >> final-report.md
                  grep -E "$pattern" build.log | head -3 | sed 's/^/  /' >> final-report.md
                  if [ "$count" -gt 3 ]; then
                    echo "  ... (and $((count-3)) more)" >> final-report.md
                  fi
                  echo '  ```' >> final-report.md
                fi
              done
              
              echo "" >> final-report.md
              echo "### ðŸ“„ Full Log" >> final-report.md
              echo "Download \`build.log\` artifact for complete details." >> final-report.md
            fi
          else
            echo "âš ï¸ Build log not found" >> final-report.md
          fi
          
          echo "" >> final-report.md
          echo "## ðŸ–¥ï¸ Environment" >> final-report.md
          echo "- Java: $(java -version 2>&1 | head -1)" >> final-report.md
          echo "- Gradle: $(./gradlew --version | grep "Gradle ")" >> final-report.md
          echo "- Kotlin: $(./gradlew --version | grep "Kotlin:")" >> final-report.md

      # ========== ä¸Šä¼ æ‰€æœ‰äº§ç‰© ==========
      - name: ðŸ“¤ Upload diagnostic artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: diagnostic-reports
          path: |
            build.log
            build_fixed.log
            final-report.md
            app/build/reports/
          if-no-files-found: ignore

      - name: ðŸ“¦ Upload APK (if built)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk