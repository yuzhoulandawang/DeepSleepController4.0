name: ðŸ” Smart Diagnostic Build with Error Categorization

on:
  workflow_dispatch:

jobs:
  diagnose-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ========== çŽ¯å¢ƒæ¸…ç† ==========
      - name: ðŸ§¹ Wipe Gradle caches and warm up
        run: |
          ./gradlew --stop
          rm -rf ~/.gradle/caches/
          ./gradlew help --stacktrace

      # ========== æ”¶é›†çŽ¯å¢ƒä¿¡æ¯ ==========
      - name: ðŸ“‹ Collect environment info
        id: env_info
        run: |
          echo "### System Info" >> $GITHUB_STEP_SUMMARY
          echo "- Java: $(java -version 2>&1 | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "- Gradle Wrapper version: $(./gradlew --version | grep "Gradle ")" >> $GITHUB_STEP_SUMMARY
          echo "- Kotlin: $(./gradlew --version | grep "Kotlin:")" >> $GITHUB_STEP_SUMMARY
          
          # ä»Ž version catalog è¯»å– AGP å’Œ Kotlin ç‰ˆæœ¬ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          if [ -f gradle/libs.versions.toml ]; then
            AGP_VERSION=$(grep -E "^agp" gradle/libs.versions.toml | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "unknown")
            KOTLIN_VERSION=$(grep -E "^kotlin" gradle/libs.versions.toml | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "unknown")
          else
            AGP_VERSION="unknown (no version catalog)"
            KOTLIN_VERSION="unknown (no version catalog)"
          fi
          echo "### Compatibility Check" >> $GITHUB_STEP_SUMMARY
          echo "- AGP version (catalog): $AGP_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- Kotlin version (catalog): $KOTLIN_VERSION" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥ Gradle ä¸Ž AGP å…¼å®¹æ€§ï¼ˆç®€å•æç¤ºï¼‰
          GRADLE_VERSION=$(grep distributionUrl gradle/wrapper/gradle-wrapper.properties | grep -oE 'gradle-[0-9.]+' | cut -d- -f2)
          echo "- Gradle version: $GRADLE_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸  Ensure Gradle and AGP versions are compatible: https://developer.android.com/studio/releases/gradle-plugin#updating-gradle" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“„ Show key config files
        run: |
          echo "### app/build.gradle.kts (first 20 lines)" >> $GITHUB_STEP_SUMMARY
          head -20 app/build.gradle.kts >> $GITHUB_STEP_SUMMARY
          echo "### gradle/libs.versions.toml" >> $GITHUB_STEP_SUMMARY
          cat gradle/libs.versions.toml >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“± List installed Android SDK components
        run: |
          echo "### Installed SDK Packages" >> $GITHUB_STEP_SUMMARY
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --list_installed >> $GITHUB_STEP_SUMMARY

      # ========== åˆ·æ–°ä¾èµ– ==========
      - name: ðŸ§¹ Clean and refresh dependencies
        run: ./gradlew clean --refresh-dependencies

      # ========== è¯Šæ–­ï¼šä¾èµ–æ´žå¯Ÿ ==========
      - name: ðŸ”Ž Dependency insights (JavaPoet, KSP, Compose)
        run: |
          echo "### JavaPoet version insight" >> $GITHUB_STEP_SUMMARY
          ./gradlew app:dependencyInsight --dependency javapoet --configuration debugCompileClasspath >> $GITHUB_STEP_SUMMARY || true
          echo "### KSP version insight" >> $GITHUB_STEP_SUMMARY
          ./gradlew app:dependencyInsight --dependency ksp --configuration debugCompileClasspath >> $GITHUB_STEP_SUMMARY || true

      # ========== é¦–æ¬¡æž„å»ºå°è¯• ==========
      - name: ðŸ—ï¸ First build attempt
        id: first_build
        run: |
          ./gradlew assembleDebug --stacktrace 2>&1 | tee build.log
        continue-on-error: true

      # ========== æ£€æµ‹ç‰¹å®šå†²çªï¼ˆä»…è¾“å‡ºè¯Šæ–­ï¼Œä¸è‡ªåŠ¨ä¿®å¤ï¼‰ ==========
      - name: ðŸ”Ž Check for Hilt/JavaPoet conflict
        if: always()
        run: |
          if grep -q "java.lang.NoSuchMethodError.*javapoet\|com.squareup.javapoet.ClassName.canonicalName" build.log; then
            echo "### âš ï¸ Hilt/JavaPoet Conflict Detected" >> $GITHUB_STEP_SUMMARY
            echo "This is often caused by mismatched versions of Room, Hilt, or other annotation processors." >> $GITHUB_STEP_SUMMARY
            echo "Suggested fix: Add a dependency constraint in app/build.gradle.kts:" >> $GITHUB_STEP_SUMMARY
            echo '```kotlin' >> $GITHUB_STEP_SUMMARY
            echo 'configurations.all {' >> $GITHUB_STEP_SUMMARY
            echo '    resolutionStrategy {' >> $GITHUB_STEP_SUMMARY
            echo '        force "com.squareup:javapoet:1.13.0"' >> $GITHUB_STEP_SUMMARY
            echo '    }' >> $GITHUB_STEP_SUMMARY
            echo '}' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No Hilt/JavaPoet conflict detected." >> $GITHUB_STEP_SUMMARY
          fi

      # ========== ç”Ÿæˆåˆ†ç±»é”™è¯¯æŠ¥å‘Š ==========
      - name: ðŸ“Š Generate categorized error report
        if: always()
        run: |
          echo "# ðŸ“‹ Build Diagnostic Report (Categorized)" > final-report.md
          echo "" >> final-report.md
          echo "## ðŸ” Summary" >> final-report.md
          if [ -f build.log ]; then
            if grep -q "BUILD SUCCESSFUL" build.log; then
              echo "âœ… **Build succeeded**" >> final-report.md
            else
              echo "âŒ **Build failed**" >> final-report.md
              echo "" >> final-report.md
              echo "### ðŸ“Š Error Categories" >> final-report.md
              
              declare -A error_patterns=(
                ["KSP/Kotlinç‰ˆæœ¬ä¸å…¼å®¹"]="ksp.*is too new for kotlin|Kotlin version .* is not compatible with KSP"
                ["æŒ‚èµ·å‡½æ•°è°ƒç”¨é”™è¯¯"]="Suspend function.*should be called only from a coroutine"
                ["æœªè§£å†³çš„å¼•ç”¨"]="Unresolved reference"
                ["ç±»åž‹ä¸åŒ¹é…"]="type mismatch"
                ["å‚æ•°ä¸åŒ¹é…"]="No value passed for parameter|Cannot find a parameter"
                ["å‡½æ•°é‡è½½å†²çª"]="Conflicting overloads"
                ["ç¼ºå°‘å¯¼å…¥"]="Unresolved reference.*(import|kotlinx)"
                ["Composeä¸Šä¸‹æ–‡é”™è¯¯"]="@Composable invocations can only happen from the context of a @Composable function"
                ["èµ„æºç¼ºå¤±"]="resource.*not found"
                ["ä¾èµ–å†²çª"]="Conflict|dependency convergence"
                ["Hilt/JavaPoetå†²çª"]="java.lang.NoSuchMethodError.*javapoet|com.squareup.javapoet.ClassName.canonicalName"
                ["Kotlinç‰ˆæœ¬ä¸åŒ¹é…"]="This version .* is not supported by the Kotlin plugin"
                ["å…¶ä»–é”™è¯¯"]="^e:|^error:|FAILURE:"
              )
              
              for category in "${!error_patterns[@]}"; do
                pattern="${error_patterns[$category]}"
                # ä½¿ç”¨ grep -E å¹¶ç»Ÿè®¡è¡Œæ•°
                count=$(grep -E "$pattern" build.log | wc -l)
                if [ "$count" -gt 0 ]; then
                  echo "- **$category**: $count occurrences" >> final-report.md
                  echo '  ```' >> final-report.md
                  # æ˜¾ç¤ºå‰3ä¸ªåŒ¹é…çš„å®Œæ•´è¡Œï¼ˆä¿ç•™ä¸Šä¸‹æ–‡ï¼‰
                  grep -E "$pattern" build.log | head -5 | sed 's/^/  /' >> final-report.md
                  if [ "$count" -gt 5 ]; then
                    echo "  ... (and $((count-5)) more)" >> final-report.md
                  fi
                  echo '  ```' >> final-report.md
                fi
              done
              
              echo "" >> final-report.md
              echo "### ðŸ“„ Full Log" >> final-report.md
              echo "Download \`build.log\` artifact for complete details." >> final-report.md
            fi
          else
            echo "âš ï¸ Build log not found" >> final-report.md
          fi
          
          echo "" >> final-report.md
          echo "## ðŸ–¥ï¸ Environment" >> final-report.md
          echo "- Java: $(java -version 2>&1 | head -1)" >> final-report.md
          echo "- Gradle: $(./gradlew --version | grep "Gradle ")" >> final-report.md
          echo "- Kotlin: $(./gradlew --version | grep "Kotlin:")" >> final-report.md

      # ========== ä¸Šä¼ æ‰€æœ‰è¯Šæ–­äº§ç‰© ==========
      - name: ðŸ“¤ Upload diagnostic artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: diagnostic-reports
          path: |
            build.log
            final-report.md
            app/build/reports/
          if-no-files-found: ignore

      # ========== ä¸Šä¼  APKï¼ˆå¦‚æžœå­˜åœ¨ï¼‰ ==========
      - name: ðŸ“¦ Upload APK (if built)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk
          if-no-files-found: ignore